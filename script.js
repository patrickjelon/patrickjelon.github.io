let selectedPlayer=null,isDrawing=!1,currentRoute=null,drawingMode=null,activePlayer=null,lastPoint=null,routePoints=[],isDragging=!1;function handleTouchMove(e){selectedPlayer&&!isDrawing&&(e.preventDefault(),isDragging=!0,drag(e))}function handleTouchEnd(e){document.removeEventListener("touchmove",handleTouchMove),document.removeEventListener("touchend",handleTouchEnd),isDragging||showRouteMenu(e),isDragging=!1,selectedPlayer=null}function createPlayer(e,t,r,n,o){let a=document.createElement("div");a.className="player"+(o?" quarterback":"");let l=document.createElement("span");l.className="player-symbol",l.textContent=r,a.appendChild(l),a.style.left=e+"px",a.style.top=t+"px",a.style.color=n,a.route=null,a.addEventListener("mousedown",handlePlayerMouseDown),a.addEventListener("click",e=>{isDragging||showRouteMenu(e)}),a.addEventListener("touchstart",handlePlayerMouseDown,{passive:!1}),document.querySelector(".field-container").appendChild(a)}function handlePlayerMouseDown(e){if(!isDrawing&&(selectedPlayer=e.target.closest(".player"))){if("touchstart"===e.type){e.preventDefault(),isDragging=!1;let t=e.touches[0],r=selectedPlayer.getBoundingClientRect();selectedPlayer.offsetX=t.clientX-r.left,selectedPlayer.offsetY=t.clientY-r.top,document.addEventListener("touchmove",handleTouchMove,{passive:!1}),document.addEventListener("touchend",handleTouchEnd)}else{let n=selectedPlayer.getBoundingClientRect();selectedPlayer.offsetX=e.clientX-n.left,selectedPlayer.offsetY=e.clientY-n.top,document.addEventListener("mousemove",drag),document.addEventListener("mouseup",stopDragging)}}}function drag(e){if(!selectedPlayer||isDrawing)return;let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n="touchmove"===e.type?e.touches[0].clientX:e.clientX,o="touchmove"===e.type?e.touches[0].clientY:e.clientY,a=n-r.left-selectedPlayer.offsetX,l=o-r.top-selectedPlayer.offsetY;a=Math.max(0,Math.min(a,t.clientWidth-45)),l=Math.max(0,Math.min(l,t.clientHeight-45));let i=a-parseInt(selectedPlayer.style.left),u=l-parseInt(selectedPlayer.style.top);selectedPlayer.style.left=a+"px",selectedPlayer.style.top=l+"px",selectedPlayer.route&&updateRoutePosition(selectedPlayer,i,u)}function updateRoutePosition(e,t,r){if(!e.route)return;let n=e.route.querySelector("path");if(!n)return;let o=e.routePoints.map((e,n)=>{if(0===n){let[o,a,l]=e.split(" ");return`M ${parseFloat(a)+t} ${parseFloat(l)+r}`}{let[i,u,s]=e.split(" ");return`L ${parseFloat(u)+t} ${parseFloat(s)+r}`}});n.setAttribute("d",o.join(" ")),e.routePoints=o}function stopDragging(){selectedPlayer=null,document.removeEventListener("mousemove",drag),document.removeEventListener("mouseup",stopDragging),document.removeEventListener("touchmove",drag),document.removeEventListener("touchend",stopDragging)}function updateQBButtonState(){let e=document.querySelector(".add-qb"),t=null!==document.querySelector(".player.quarterback");e.style.opacity=t?"0.5":"1",e.style.cursor=t?"default":"pointer"}function addPlayer(e){if(!isDrawing){if("quarterback"===e){if(document.querySelector(".player.quarterback"))return;createPlayer(50,200,"Q","white",!0)}else createPlayer(105,200,"X","white",!1);updateQBButtonState()}}function showRouteMenu(e){e.stopPropagation();let t=e.target.closest(".player");if(!t)return;let r=document.querySelector(".popup-menu");r&&r.remove();let n=document.createElement("div");n.className="popup-menu",activePlayer=t;let o=[{text:"Draw Straight Route",action:()=>startRoute("straight",n)},{text:"Draw Curve Route",action:()=>startRoute("curve",n)},{text:"Name Player",action:()=>handleNameClick(n)}];t.route&&o.push({text:"Delete Route",action:()=>deleteRoute(n),color:"#f44336"}),o.push({text:"Remove Player",action:()=>removePlayer(n),color:"#f44336"}),o.forEach(e=>{let t=document.createElement("button");t.textContent=e.text,e.color&&(t.style.color=e.color);let r=t=>{t.preventDefault(),t.stopPropagation(),e.action()};t.addEventListener("click",r),t.addEventListener("touchend",r,{passive:!1}),n.appendChild(t)}),t.appendChild(n);let a=t.getBoundingClientRect(),l=n.offsetWidth;a.right+l>window.innerWidth?(n.style.left="auto",n.style.right="100%"):(n.style.left="100%",n.style.right="auto");let i=e=>{n.contains(e.target)||e.target===t||(closePopupMenu(),document.removeEventListener("click",i),document.removeEventListener("touchstart",i))};document.addEventListener("click",i),document.addEventListener("touchstart",i,{passive:!0})}function startRoute(e,t){drawingMode=e,isDrawing=!0,t.closest(".popup-menu").remove();let r=document.querySelector(".field-container");activePlayer.route&&(activePlayer.route.remove(),activePlayer.route=null,activePlayer.routePoints=null),(currentRoute=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("route"),currentRoute.style.width="100%",currentRoute.style.height="100%",currentRoute.style.position="absolute",currentRoute.style.top="0",currentRoute.style.left="0";let n=document.createElementNS("http://www.w3.org/2000/svg","defs"),o=document.createElementNS("http://www.w3.org/2000/svg","marker");o.setAttribute("id","arrowhead-"+Date.now()),o.setAttribute("markerHeight","5.5"),o.setAttribute("refX","0"),o.setAttribute("refY","1.75"),o.setAttribute("orient","auto");let a=document.createElementNS("http://www.w3.org/2000/svg","polygon");a.setAttribute("points","0 0, 3.5 1.75, 0 3.5"),o.appendChild(a),n.appendChild(o),currentRoute.appendChild(n);let l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("stroke","#B4B766"),l.setAttribute("stroke-width","4"),l.setAttribute("fill","none"),l.setAttribute("marker-end",`url(#${o.id})`);let i=parseInt(activePlayer.style.left)+22,u=parseInt(activePlayer.style.top)+22;l.setAttribute("d",`M ${i} ${u}`),lastPoint={x:i,y:u},routePoints=[`M ${i} ${u}`],currentRoute.appendChild(l),r.appendChild(currentRoute),document.querySelector(".drawing-controls").classList.add("active"),"curve"===e?(r.addEventListener("mousedown",startCurveDrawing),activePlayer.classList.add("drawing")):setTimeout(()=>{r.addEventListener("click",addStraightLinePoint),activePlayer.classList.add("drawing")},50)}function addStraightLinePoint(e){if(!isDrawing||"straight"!==drawingMode)return;let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top,a=currentRoute.querySelector("path");routePoints.push(`L ${n} ${o}`),a.setAttribute("d",routePoints.join(" ")),lastPoint={x:n,y:o}}function startCurveDrawing(e){isDrawing&&"curve"===drawingMode&&(document.addEventListener("mousemove",drawCurve),document.addEventListener("mouseup",stopCurveDrawing))}function drawCurve(e){if(!isDrawing||"curve"!==drawingMode)return;let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top,a=currentRoute.querySelector("path");routePoints.push(`L ${n} ${o}`),a.setAttribute("d",routePoints.join(" "))}function undoRoute(){if(!isDrawing||routePoints.length<=1)return;routePoints.pop();let e=currentRoute.querySelector("path");e.setAttribute("d",routePoints.join(" "))}function stopCurveDrawing(){document.removeEventListener("mousemove",drawCurve),document.removeEventListener("mouseup",stopCurveDrawing)}function finishRoute(){if(!isDrawing)return;let e=currentRoute.querySelector("path"),t=e.getAttribute("d"),r=t.split(" "),n,o,a,l;for(let i=r.length-1;i>=0;i--)if(r[i].startsWith("L")||r[i].startsWith("M")){[n,o]=r[i+1].split(",").map(Number),i>0&&([a,l]=r[i].substring(1).split(",").map(Number));break}activePlayer.route=currentRoute,activePlayer.routePoints=routePoints,cleanupRouteDrawing()}function cancelRoute(){isDrawing&&(currentRoute&&currentRoute.remove(),cleanupRouteDrawing())}function removePlayer(e){activePlayer&&(activePlayer.route&&activePlayer.route.remove(),activePlayer.remove(),activePlayer=null),e.remove(),updateQBButtonState()}function deleteRoute(e){activePlayer&&activePlayer.route&&(activePlayer.route.remove(),activePlayer.route=null,activePlayer.routePoints=null),e.remove()}function cleanupRouteDrawing(){isDrawing=!1,drawingMode=null,currentRoute=null,lastPoint=null,activePlayer&&(activePlayer.classList.remove("drawing"),activePlayer=null);let e=document.querySelector(".field-container");e.removeEventListener("click",addStraightLinePoint),e.removeEventListener("mousedown",startCurveDrawing),document.removeEventListener("mousemove",drawCurve),document.removeEventListener("mouseup",stopCurveDrawing),document.querySelector(".drawing-controls").classList.remove("active")}function handleNameClick(e){let t=prompt("Enter player name or number (1-15 characters):");if(t&&t.trim().length>0&&t.trim().length<=15){let r=activePlayer.querySelector(".player-name");r||((r=document.createElement("div")).className="player-name",activePlayer.appendChild(r)),r.textContent=t.trim()}e.remove()}function saveAsImage(){let e=document.querySelector(".field-container");html2canvas(e,{backgroundColor:null,scale:2,logging:!1,useCORS:!0}).then(e=>{let t=document.createElement("a");t.download="football-play.png",t.href=e.toDataURL("image/png"),t.click()})}function closePopupMenu(){let e=document.querySelector(".popup-menu");e&&e.remove()}document.addEventListener("keydown",function(e){e.ctrlKey&&"z"===e.key&&isDrawing&&(e.preventDefault(),undoRoute())}),document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".field-container").addEventListener("contextmenu",e=>e.preventDefault()),updateQBButtonState()});