let selectedPlayer=null,isDrawing=!1,currentRoute=null,drawingMode=null,activePlayer=null,lastPoint=null,routePoints=[];function createPlayer(e,t,r,n,o){let i=document.createElement("div");i.className="player"+(o?" quarterback":"");let l=document.createElement("span");l.className="player-symbol",l.textContent=r,i.appendChild(l),i.style.left=e+"px",i.style.top=t+"px",i.style.color=n,i.route=null,i.addEventListener("mousedown",handlePlayerMouseDown),i.addEventListener("touchstart",handlePlayerMouseDown),i.addEventListener("click",showRouteMenu),document.querySelector(".field-container").appendChild(i)}function handlePlayerMouseDown(e){if(isDrawing)return;"touchstart"===e.type&&e.preventDefault();let t="touchstart"===e.type?e.touches[0].clientX:e.clientX,r="touchstart"===e.type?e.touches[0].clientY:e.clientY;if(!(selectedPlayer=e.target.closest(".player")))return;let n=selectedPlayer.getBoundingClientRect();selectedPlayer.offsetX=t-n.left,selectedPlayer.offsetY=r-n.top,"touchstart"===e.type?(document.addEventListener("touchmove",drag),document.addEventListener("touchend",stopDragging)):(document.addEventListener("mousemove",drag),document.addEventListener("mouseup",stopDragging))}function drag(e){if(!selectedPlayer||isDrawing)return;"touchmove"===e.type&&e.preventDefault();let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n="touchmove"===e.type?e.touches[0].clientX:e.clientX,o="touchmove"===e.type?e.touches[0].clientY:e.clientY,i=n-r.left-selectedPlayer.offsetX,l=o-r.top-selectedPlayer.offsetY;i=Math.max(0,Math.min(i,t.clientWidth-45)),l=Math.max(0,Math.min(l,t.clientHeight-45));let a=i-parseInt(selectedPlayer.style.left),u=l-parseInt(selectedPlayer.style.top);selectedPlayer.style.left=i+"px",selectedPlayer.style.top=l+"px",selectedPlayer.route&&updateRoutePosition(selectedPlayer,a,u)}function updateRoutePosition(e,t,r){if(!e.route)return;let n=e.route.querySelector("path");if(!n)return;let o=e.routePoints.map((e,n)=>{if(0===n){let[o,i,l]=e.split(" ");return`M ${parseFloat(i)+t} ${parseFloat(l)+r}`}{let[a,u,s]=e.split(" ");return`L ${parseFloat(u)+t} ${parseFloat(s)+r}`}});n.setAttribute("d",o.join(" ")),e.routePoints=o}function stopDragging(){selectedPlayer=null,document.removeEventListener("mousemove",drag),document.removeEventListener("mouseup",stopDragging),document.removeEventListener("touchmove",drag),document.removeEventListener("touchend",stopDragging)}function updateQBButtonState(){let e=document.querySelector(".add-qb"),t=null!==document.querySelector(".player.quarterback");e.style.opacity=t?"0.5":"1",e.style.cursor=t?"default":"pointer"}function addPlayer(e){if(!isDrawing){if("quarterback"===e){if(document.querySelector(".player.quarterback"))return;createPlayer(50,200,"Q","white",!0)}else createPlayer(105,200,"X","white",!1);updateQBButtonState()}}function showRouteMenu(e){if(isDrawing)return;let t=document.querySelector(".popup-menu");t&&t.remove();let r=document.createElement("div");r.className="popup-menu",r.innerHTML=`
        <button onclick="startRoute('straight', this)">Draw Straight Route</button>
        <button onclick="startRoute('curve', this)">Draw Curve Route</button>
        <button onclick="handleNameClick(this)">Name Player</button>
        <button onclick="removePlayer(this)" style="color: #f44336;">Remove Player</button>
    `;let n=e.target.closest(".player");if(!n)return;let o=n.getBoundingClientRect();r.style.left=o.right+5+"px",r.style.top=o.top+"px",document.body.appendChild(r),activePlayer=n;let i=e=>{r.contains(e.target)||e.target===activePlayer||(r.remove(),document.removeEventListener("click",i))};setTimeout(()=>document.addEventListener("click",i),0)}function startRoute(e,t){drawingMode=e,isDrawing=!0,t.closest(".popup-menu").remove();let r=document.querySelector(".field-container");activePlayer.route&&(activePlayer.route.remove(),activePlayer.route=null,activePlayer.routePoints=null),(currentRoute=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("route"),currentRoute.style.width="100%",currentRoute.style.height="100%",currentRoute.style.position="absolute",currentRoute.style.top="0",currentRoute.style.left="0";let n=document.createElementNS("http://www.w3.org/2000/svg","defs"),o=document.createElementNS("http://www.w3.org/2000/svg","marker");o.setAttribute("id","arrowhead-"+Date.now()),o.setAttribute("markerHeight","5.5"),o.setAttribute("refX","0"),o.setAttribute("refY","1.75"),o.setAttribute("orient","auto");let i=document.createElementNS("http://www.w3.org/2000/svg","polygon");i.setAttribute("points","0 0, 3.5 1.75, 0 3.5"),o.appendChild(i),n.appendChild(o),currentRoute.appendChild(n);let l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("stroke","#B4B766"),l.setAttribute("stroke-width","4"),l.setAttribute("fill","none"),l.setAttribute("marker-end",`url(#${o.id})`);let a=parseInt(activePlayer.style.left)+22,u=parseInt(activePlayer.style.top)+22;l.setAttribute("d",`M ${a} ${u}`),lastPoint={x:a,y:u},routePoints=[`M ${a} ${u}`],currentRoute.appendChild(l),r.appendChild(currentRoute),document.querySelector(".drawing-controls").classList.add("active"),"curve"===e?r.addEventListener("mousedown",startCurveDrawing):r.addEventListener("click",addStraightLinePoint),activePlayer.classList.add("drawing")}function addStraightLinePoint(e){if(!isDrawing||"straight"!==drawingMode)return;let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top,i=currentRoute.querySelector("path");routePoints.push(`L ${n} ${o}`),i.setAttribute("d",routePoints.join(" ")),lastPoint={x:n,y:o}}function startCurveDrawing(e){isDrawing&&"curve"===drawingMode&&(document.addEventListener("mousemove",drawCurve),document.addEventListener("mouseup",stopCurveDrawing))}function drawCurve(e){if(!isDrawing||"curve"!==drawingMode)return;let t=document.querySelector(".field-container"),r=t.getBoundingClientRect(),n=e.clientX-r.left,o=e.clientY-r.top,i=currentRoute.querySelector("path");routePoints.push(`L ${n} ${o}`),i.setAttribute("d",routePoints.join(" "))}function undoRoute(){if(!isDrawing||routePoints.length<=1)return;routePoints.pop();let e=currentRoute.querySelector("path");e.setAttribute("d",routePoints.join(" "))}function stopCurveDrawing(){document.removeEventListener("mousemove",drawCurve),document.removeEventListener("mouseup",stopCurveDrawing)}function finishRoute(){if(!isDrawing)return;let e=currentRoute.querySelector("path"),t=e.getAttribute("d"),r=t.split(" "),n,o,i,l;for(let a=r.length-1;a>=0;a--)if(r[a].startsWith("L")||r[a].startsWith("M")){[n,o]=r[a+1].split(",").map(Number),a>0&&([i,l]=r[a].substring(1).split(",").map(Number));break}activePlayer.route=currentRoute,activePlayer.routePoints=routePoints,cleanupRouteDrawing()}function cancelRoute(){isDrawing&&(currentRoute&&currentRoute.remove(),cleanupRouteDrawing())}function removePlayer(e){let t=e.closest(".popup-menu");activePlayer&&(activePlayer.route&&activePlayer.route.remove(),activePlayer.remove(),activePlayer=null),t.remove(),updateQBButtonState()}function cleanupRouteDrawing(){isDrawing=!1,drawingMode=null,currentRoute=null,lastPoint=null,activePlayer&&(activePlayer.classList.remove("drawing"),activePlayer=null);let e=document.querySelector(".field-container");e.removeEventListener("click",addStraightLinePoint),e.removeEventListener("mousedown",startCurveDrawing),document.removeEventListener("mousemove",drawCurve),document.removeEventListener("mouseup",stopCurveDrawing),document.querySelector(".drawing-controls").classList.remove("active")}function handleNameClick(e){let t=prompt("Enter player name or number (1-15 characters):");if(t&&t.trim().length>0&&t.trim().length<=15){let r=activePlayer.querySelector(".player-name");r||((r=document.createElement("span")).className="player-name",activePlayer.appendChild(r)),r.textContent=t.trim()}e.closest(".popup-menu").remove()}function saveAsImage(){let e=document.querySelector(".field-container");html2canvas(e,{backgroundColor:null,scale:2,logging:!1,useCORS:!0}).then(e=>{let t=document.createElement("a");t.download="football-play.png",t.href=e.toDataURL("image/png"),t.click()})}document.addEventListener("keydown",function(e){e.ctrlKey&&"z"===e.key&&isDrawing&&(e.preventDefault(),undoRoute())}),document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".field-container").addEventListener("contextmenu",e=>e.preventDefault()),updateQBButtonState()});